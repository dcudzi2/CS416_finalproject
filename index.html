<html>
<script src="https://d3js.org/d3.v4.js"></script>

<style>
    .center {
        margin: auto;
        width: 80%;
        border: 3px solid #73AD21;
        padding: 30px;
    }
</style>
    
<div id="buttons">
<h1 style="font-family: Helvetica; text-align:center; font-size: 30px">
    CS416: Air Quality 2020 (EPA)
</h1>
<h2 style="font-family: Helvetica; text-align:center; font-size: 15px">
    <em>By Daniel Cudzich as part of Summer 2023</em>
</h2>
</div>

<div id="division" style="text-align:center;">
    <p class="center" style="font-family: Helvetica; font-size: 12px">
        The Environmental Protection Agency (EPA) tracks air quality data across the United States, with meteorological stations running to collect data on a daily basis, sometimes even hourly. This allows for extensive tracking over time as well as comparisons between geographic regions, although major gaps do exist within and between states, with some states missing data for certain pollutants entirely. This data visualization illustrates air quality across the U.S., with notable trends, caveats, and additional details provided where relevant.
    </p>
    
    <!--Buttons change index of what's obtained from the map, resulting in a change on the map.-->
    <button onclick="update(0)">AQI</button>
    <button onclick="update(1)">Nitrous (NO2)</button>
    <button onclick="update(2)">Ozone (O3)</button>
        
    <svg id="mainmap" width="750" height="500" style="border:1px solid black"></svg>
</div>

<script>

//data_O3 = await d3.csv("https://dcudzi2.github.io/CS416_finalproject/daily_44201_2020_OZONE_ABRIDGED.csv");
//data_NO2 = await d3.csv("https://dcudzi2.github.io/CS416_finalproject/daily_42602_2020_NO2_ABRIDGED.csv");

//LET FUNCTIONS FOR EVENTS
let mouseOver = function(d) {
    d3.selectAll(".State")
        .transition()
        .duration(100)
        .style("opacity", .5)
    d3.select(this)
        .transition()
        .duration(100)
        .style("opacity", 1)
    return tooltip.style("visibility", "visible");
}
  
let mouseLeave = function(d) {
    d3.selectAll(".State")
        .transition()
        .duration(100)
        .style("opacity", .8)
    d3.select(this)
        .transition()
        .duration(100)
    d3.select(this)
        .transition()
        .duration(100)
        .style("opacity", 0.8)
    return tooltip.style("visibility", "hidden");
}

let mouseMove = function(d) {
    return tooltip
        .style("top", (d3.event.pageY-30)+"px")
        .style("left",(d3.event.pageX+10)+"px")
        .html(d.properties.name + ": "+d.pollutant_val)
        //JSON.stringify(d) to investigate contents of the state data
}

//Toooltip setup
var tooltip = d3.select("body")
    .append("div")
    .style("position", "absolute")
    .style("z-index", "10")
    .style("visibility", "hidden")
    .style("background-color", "white")
    .style("font-family", "Helvetica")
    .style("font-size", "14px")
    .style("border", "3px solid #73AD21")
    .style("padding", "5px")
    .html("You should not be seeing this.");
    
var svg = d3.select("#mainmap"),
  width = +svg.attr("width"),
  height = +svg.attr("height");

//Get the map created and centered
var path = d3.geoPath();
var projection = d3.geoMercator()
  .scale(325)
  .center([-125,52])
  .translate([width / 2, height / 2]);

//DATA IS A MAP - this complicates things but I don't know how to implement it better
var data = d3.map();
var colorScale = d3.scaleLinear()
  .domain([0,12.5,25])
  .range(['green','yellow','red']);

// Load external data and boot
d3.queue()
  .defer(d3.json, "https://dcudzi2.github.io/CS416_finalproject/us-states1.json")
  .defer(d3.csv, "https://dcudzi2.github.io/CS416_finalproject/statesdata1.csv", function(d) { data.set(d.id, [d.value, d.value2, d.value3]); })
  .await(ready);

function ready(error, topo) {

    //Accepts an integer that updates the index that is taken from the map
    function update(index) {
      var u = svg.selectAll(".test")
      	.data(topo.features)
        
      u
      	.enter()
        .append("path")
        .attr("class", ".test")
        .style("opacity", .8)
        .merge(u)
        //
        .on("mouseover", mouseOver)
        .on("mouseleave", mouseLeave)
        .on("mousemove", mouseMove)
        .transition().duration(3000)
 
        .attr("d", d3.geoPath()
         	.projection(projection))
          // set the color of each State
        .attr("fill", function (d) {
            d.pollutant_val = data.get(d.id)[index] || 0;
            return colorScale(d.pollutant_val);
          })
        .style("stroke", "transparent")
        .attr("class", function(d){ return "State" })

    }

    update(0)
}

</script>

<p style="font-family: Helvetica; font-size: 10px">
    <em>EPA data obtained from <a href="https://aqs.epa.gov/aqsweb/airdata/download_files.html#Meta">this EPA website allowing for downloads of prepared summary data.</a> Look for the "Daily Summary Data" table, year 2020. Data has been averaged over each state and over the full year for representation on the choropleths.</em>
</p>
<p style="font-family: Helvetica; font-size: 10px">
    <em>Many thanks to <a href="https://d3-graph-gallery.com/graph/choropleth_hover_effect.html">Yan Holtz</a> for this resource in creating choropleths with D3.</em>
</p>
    
</html>
